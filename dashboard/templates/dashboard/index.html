{% load static %}
{% load humanize %}

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Sharp" rel="stylesheet">
<link rel="stylesheet" href="{% static 'dashboard/style.css' %}">
<title>Dashboard | MoreLen</title>
<style>
    main section.custom-section { display: none; margin-bottom: 30px; }
    main section.custom-section.active { display: block; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { text-align: left; padding: 10px; border-bottom: 1px solid #ddd; }
    th { background-color: #f0f0f0; }
    img.avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; }
    a { color: #007bff; text-decoration: none; }
    a:hover { text-decoration: underline; }
    body.dark-mode-variables { background-color: #181a1e; color: #f1f1f1; }
    body.dark-mode-variables table { background-color: #1e1f24; color: #eaeaea; border-color: #444; }
    body.dark-mode-variables th { background-color: #2c2e35 !important; color: #fff !important; border-bottom: 1px solid #444; }
    body.dark-mode-variables td { color: #e5e5e5 !important; border-bottom: 1px solid #333; }
    body.dark-mode-variables h1,h2,h3,p,a { color: #f0f0f0 !important; }
    body.dark-mode-variables a:hover { color: #00b4d8 !important; }
    body.dark-mode-variables aside { background-color: #1a1b20 !important; }
</style>
</head>
<body>

<div class="container">

    <aside>
        <div class="toggle">
            <div class="logo">
                <img src="{% static 'dashboard/images/More len.png' %}" style="width:50px; height:50px; object-fit:contain;">
                <h2>More<span class="danger">Len</span></h2>
            </div>
            <div class="close" id="close-btn"><span class="material-icons-sharp">close</span></div>
        </div>
        <div class="sidebar">
            <a href="#" class="active" data-target="dashboard-section"><span class="material-icons-sharp">dashboard</span><h3>Dashboard</h3></a>
            <a href="#" data-target="users-section"><span class="material-icons-sharp">person_outline</span><h3>Users</h3></a>
            <a href="#" data-target="products-section"><span class="material-icons-sharp">inventory</span><h3>Products</h3></a>
            <a href="#" data-target="categories-section"><span class="material-icons-sharp">category</span><h3>Categories</h3></a>
            <a href="#" data-target="orders-section"><span class="material-icons-sharp">receipt_long</span><h3>Orders</h3></a>
            <a href="#" data-target="payments-section"><span class="material-icons-sharp">payment</span><h3>Payments</h3></a>
            <a href="#" data-target="revenues-section"><span class="material-icons-sharp">analytics</span><h3>Revenues</h3></a>
            <a href="#"><span class="material-icons-sharp">settings</span><h3>Settings</h3></a>
            <a href="#"><span class="material-icons-sharp">add</span><h3>New Login</h3></a>
            <a href="http://localhost:5173/login"><span class="material-icons-sharp">logout</span><h3>Logout</h3></a>
        </div>
    </aside>

    <main>

        <div id="dashboard-section">
            <h1>Analytics</h1>
            <div class="analyse">
                <div class="sales">
                    <div class="status">
                        <div class="info"><h3>Total Sales</h3><h1>{{ total_sales|intcomma }} VND</h1></div>
                        <div class="progresss"><svg><circle cx="38" cy="38" r="36"></circle></svg><div class="percentage"><p>+81%</p></div></div>
                    </div>
                </div>
                <div class="visits">
                    <div class="status">
                        <div class="info"><h3>Site Visit</h3><h1>24,981</h1></div>
                        <div class="progresss"><svg><circle cx="38" cy="38" r="36"></circle></svg><div class="percentage"><p>-48%</p></div></div>
                    </div>
                </div>
                <div class="searches">
                    <div class="status">
                        <div class="info"><h3>Searches</h3><h1>14,147</h1></div>
                        <div class="progresss"><svg><circle cx="38" cy="38" r="36"></circle></svg><div class="percentage"><p>+21%</p></div></div>
                    </div>
                </div>
            </div>
            <div class="new-users">
                <h2>New Users</h2>
                <div class="user-list">
                    {% for user in new_users %}
                        <div class="user">
                            {% if user.avatar %}<img src="{{ user.avatar.url }}" alt="{{ user.username }}">{% else %}<img src="{% static 'dashboard/images/profile-1.jpg' %}" alt="default avatar">{% endif %}
                            <h2>{{ user.username }}</h2>
                            <p>{{ user.date_joined|timesince }} ago</p>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <section id="users-section" class="custom-section">
            <h2>Users</h2>
            <a href="{% url 'user_create' %}" 
            class="btn-add" 
            style="float: right; background:#2196F3;color:white;padding:8px 14px;border-radius:6px;text-decoration:none;margin-bottom:8px">
            ‚ûï Add User
            </a>
            <table>
                <thead>
                    <tr><th>Avatar</th><th>Username</th><th>Email</th><th>Last name</th><th>First name</th><th>Phone</th><th>Joined</th><th>Actions</th></tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr>
                        <td>{% if user.avatar %}<img src="{{ user.avatar.url }}" class="avatar">{% else %}<img src="{% static 'dashboard/images/profile-1.jpg' %}" class="avatar">{% endif %}</td>
                        <td>{{ user.username }}</td><td>{{ user.email }}</td><td>{{user.last_name}}</td><td>{{user.first_name}}</td><td>{{ user.phone|default:"-" }}</td>
                        <td style="white-space: nowrap;">{{ user.date_joined|date:"Y-m-d H:i" }}</td>
                        <td style="vertical-align: middle; text-align: center; white-space: nowrap;">
                            <a href="{% url 'user_update' user.id %}" class="btn-edit">‚úèÔ∏è Edit</a> |
                            <a href="{% url 'user_delete' user.id %}" class="btn-delete">üóëÔ∏è Delete</a>
                        </td>   
                    </tr>
                    {% empty %}
                    <tr><td colspan="8">No users found</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </section>

        <section id="products-section" class="custom-section">
            <h2>Products</h2>
        <a href="{% url 'product_create' %}" 
        style="float:right; background:#2196F3; color:white; 
                padding:8px 14px; border-radius:6px; text-decoration:none; 
                margin-bottom:10px; display:inline-block;">
        ‚ûï Add Product
        </a>
            <table>
                <thead><tr><th>Image</th><th>Name</th><th>Category</th><th>Price</th><th>Stock</th><th>Sold</th><th>Status</th><th>Actions</th></tr></thead>
                <tbody>
                    {% for product in products %}
                    <tr>
                        <td>{% if product.image %}<img src="{{ product.image.url }}" class="avatar">{% else %}<img src="{% static 'dashboard/images/profile-1.jpg' %}" class="avatar">{% endif %}</td>
                        <td>{{ product.name }}</td><td>{% if product.category %}{{ product.category.name }}{% else %}-{% endif %}</td>
                        <td>{{ product.price }}</td><td>{{ product.stock }}</td><td>{{ product.sold }}</td><td>{{ product.get_status_display }}</td>

                        <td><a href="{% url 'product_update' product.id %}" class="btn-edit">‚úèÔ∏è Edit</a> |<a href="{% url 'product_delete' product.id %}" class="btn-delete">üóëÔ∏è Delete</a></td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="7">No products found</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </section>

        <section id="categories-section" class="custom-section">
            <h2>Categories</h2>
            <a href="{% url 'category_create' %}" 
            style="float:right; background:#2196F3; color:white; 
                    padding:8px 14px; border-radius:6px; text-decoration:none; 
                    margin-bottom:10px; display:inline-block;">
            ‚ûï Add Category
            </a>
            <table>
                <thead><tr><th>Name</th><th>Parent</th><th>Actions</th></tr></thead>
                <tbody>
                    {% for category in categories %}
                    <tr>
                        <td>{{ category.name }}</td>
                        <td>{% if category.parent %}{{ category.parent.name }}{% else %}-{% endif %}</td>
                        <td><a href="{% url 'category_update' category.id %}" class="btn-edit">‚úèÔ∏è Edit</a> |<a href="{% url 'category_delete' category.id %}" class="btn-delete">üóëÔ∏è Delete</a></td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="3">No categories found</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </section>

        <section id="orders-section" class="custom-section">
            <h2>Orders</h2>

            <style>
                .order-products {
                    list-style: none;
                    margin: 0;
                    padding: 0;
                }

                .order-products li {
                    display: grid;
                    grid-template-columns: 1fr 110px 150px;
                    align-items: center;
                    margin-bottom: 4px;
                    padding: 7px 11px;
                    border-radius: 6px;
                    font-size: 14px;
                    font-family: "Poppins", sans-serif;
                    color: #333;
                    transition: 0.2s;
                }



                .order-products li span {
                    white-space: nowrap;
                }
            </style>

            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>User</th>
                        <th>Customer Name</th>
                        <th>Customer Address</th>
                        <th>Customer Phone</th>
                        <th>Products</th>
                        <th>Total</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for order in orders %}
                    <tr>
                        <td>{{ order.id }}</td>
                        <td>{{ order.user.username }}</td>
                        <td>{{order.customer_name}}</td>
                        <td>{{order.customer_address}}</td>
                        <td>{{order.customer_phone}}</td>
                        <td>
                            <ul class="order-products">
                                {% for detail in order.order_details.all %}
                                <li>
                                    <span>{{ detail.product.name }}</span>
                                    <span>SL: {{ detail.quantity }}</span>
                                    <span>Gi√°: {{ detail.price|intcomma }} VND</span>
                                    
                                </li>
                                {% empty %}
                                <li>Kh√¥ng c√≥ s·∫£n ph·∫©m</li>
                                {% endfor %}
                            </ul>
                        </td>

                        <td>{{ order.total_price|intcomma }}</td>
                        <td>{{ order.get_status_display }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="5">No orders found</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </section>


        <section id="payments-section" class="custom-section">
            <h2>Payments</h2>
            <table>
                <thead><tr><th>Order ID</th><th>Method</th><th>Status</th><th>Amount</th></tr></thead>
                <tbody>
                    {% for payment in payments %}
                    <tr>
                        <td>{{ payment.order.id }}</td><td>{{ payment.payment_method }}</td><td>{{ payment.get_payment_status_display }}</td><td>{{ payment.amount|floatformat:0|intcomma }} VND</td>

                    </tr>
                    {% empty %}
                    <tr><td colspan="4">No payments found</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </section>

        <section id="revenues-section" class="custom-section">
            <h2>Revenues</h2>
        <style>
            .filter-form {
                display: flex;
                flex-wrap: wrap;
                align-items: center;
                gap: 10px;
                background: #f9fafb;
                padding: 12px 16px;
                border-radius: 10px;
                margin-bottom: 16px;
                box-shadow: 0 1px 4px rgba(0,0,0,0.08);
                font-family: "Poppins", sans-serif;
            }

            .filter-group {
                display: flex;
                align-items: center;
                gap: 6px;
            }

            .filter-group label {
                font-weight: 500;
                color: #333;
            }

            .filter-group input {
                padding: 6px 8px;
                border: 1px solid #ccc;
                border-radius: 6px;
                font-size: 14px;
                transition: 0.2s;
            }

            .filter-group input:focus {
                border-color: #2196F3;
                outline: none;
                box-shadow: 0 0 4px rgba(33, 150, 243, 0.4);
            }

            .filter-actions {
                margin-left: auto;
                display: flex;
                gap: 8px;
            }

            .btn-filter,
            .btn-reset {
                padding: 8px 14px;
                border: none;
                border-radius: 6px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s ease;
            }

            .btn-filter {
                background: #2196F3;
                color: white;
            }

            .btn-reset {
                background: #f1f1f1;
                color: #333;
            }

            .btn-filter:hover {
                background: #1976D2;
            }

            .btn-reset:hover {
                background: #e0e0e0;
            }
        </style>

        <form method="get" action="{% url 'dashboard_home' %}" class="filter-form">
            <input type="hidden" name="section" value="revenues-section">

            <div class="filter-group">
                <label>Ng√†y:</label>
                <input type="date" name="day" value="{{ request.GET.day }}">
            </div>

            <div class="filter-group">
                <label>Th√°ng:</label>
                <input type="number" name="month" min="1" max="12" value="{{ request.GET.month }}">
            </div>

            <div class="filter-group">
                <label>NƒÉm:</label>
                <input type="number" name="year" min="2000" max="2100" value="{{ request.GET.year }}">
            </div>

            <div class="filter-group">
                <label>S·∫£n ph·∫©m:</label>

                <input type="text" name="product_name" list="product-list" placeholder="Nh·∫≠p t√™n s·∫£n ph·∫©m..." 
                    value="{{ request.GET.product_name }}" 
                    style="padding:6px; border-radius:6px; border:1px solid #ccc; margin-right:8px;">

                <datalist id="product-list">
                    {% for p in products %}
                        <option value="{{ p.name }}">
                    {% endfor %}
                </datalist>

                <select name="product_id" style="padding:6px; border-radius:6px; border:1px solid #ccc;">
                    <option value="">-- T·∫•t c·∫£ s·∫£n ph·∫©m --</option>
                    {% for p in products %}
                        <option value="{{ p.id }}" {% if request.GET.product_id == p.id|stringformat:"s" %}selected{% endif %}>
                            {{ p.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>


            <div class="filter-actions">
                <button type="submit" class="btn-filter">üîç L·ªçc</button>
                <button type="submit" name="reset" value="1" class="btn-reset">‚Ü©Ô∏è Reset</button>
            </div>
        </form>



            <table>
                <thead><tr><th>Date</th><th>Product</th><th>Quantity</th><th>Total</th></tr></thead>
                <tbody>
                    {% for rev in revenues %}
                    <tr>
                        <td>{{ rev.date|date:"Y-m-d" }}</td>
                        <td>{{ rev.product.name }}</td>
                        <td>{{ rev.quantity }}</td>
                        <td>{{ rev.total|intcomma }} VND</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="4">No revenues found</td></tr>
                    {% endfor %}
                </tbody>
            </table>

            <p><strong>T·ªïng doanh thu:</strong> {{ total_sales|intcomma }} VND</p>

            <canvas id="revenueChart" style="width:100%; max-height:400px; margin-top:20px;"></canvas>

            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <script>
            const ctx = document.getElementById('revenueChart');
            const chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: {{ chart_labels|safe }},
                    datasets: [{
                        label: 'Doanh thu (VND)',
                        data: {{ chart_values|safe }},
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: { beginAtZero: true, ticks: { callback: value => value.toLocaleString() } }
                    },
                    plugins: {
                        title: { display: true, text: 'Bi·ªÉu ƒë·ªì doanh thu' }
                    }
                }
            });
            </script>
        </section>


    </main>

    <div class="right-section">
        <div class="nav">
            <button id="menu-btn"><span class="material-icons-sharp">menu</span></button>
            <div class="dark-mode">
                <span class="material-icons-sharp active">light_mode</span>
                <span class="material-icons-sharp">dark_mode</span>
            </div>
            <div class="profile">
                <div class="info"><p>Hey, <b>Reza</b></p><small class="text-muted">Admin</small></div>
                <div class="profile-photo"><img src="{% static 'dashboard/images/profile-1.jpg' %}"></div>
            </div>
        </div>
    </div>

</div>

<script>
    const sideMenu = document.querySelector('aside');
    document.getElementById('menu-btn').addEventListener('click', ()=>{ sideMenu.style.display='block'; });
    document.getElementById('close-btn').addEventListener('click', ()=>{ sideMenu.style.display='none'; });

    const darkMode = document.querySelector('.dark-mode');

    function updateDarkModeIcon() {
        if(document.body.classList.contains('dark-mode-variables')) {
            darkMode.querySelector('span:nth-child(1)').classList.remove('active');
            darkMode.querySelector('span:nth-child(2)').classList.add('active');    
        } else {
            darkMode.querySelector('span:nth-child(1)').classList.add('active');
            darkMode.querySelector('span:nth-child(2)').classList.remove('active');
        }
    }

    darkMode.addEventListener('click', ()=>{
        document.body.classList.toggle('dark-mode-variables');
        updateDarkModeIcon();

        if(document.body.classList.contains('dark-mode-variables')){
            localStorage.setItem('darkMode','true');
        } else {
            localStorage.setItem('darkMode','false');
        }
    });

    document.addEventListener('DOMContentLoaded', ()=>{
        if(localStorage.getItem('darkMode') === 'true'){
            document.body.classList.add('dark-mode-variables');
        } else {
            document.body.classList.remove('dark-mode-variables');
        }
        updateDarkModeIcon(); 
    });


 document.addEventListener('DOMContentLoaded', ()=>{

    const darkModeState = localStorage.getItem('darkMode');
    const darkMode = document.querySelector('.dark-mode');
    if(darkModeState === 'true'){
        document.body.classList.add('dark-mode-variables');
        darkMode.querySelector('span:nth-child(1)').classList.remove('active');
        darkMode.querySelector('span:nth-child(2)').classList.add('active');
    } else {
        document.body.classList.remove('dark-mode-variables');
        darkMode.querySelector('span:nth-child(1)').classList.add('active');
        darkMode.querySelector('span:nth-child(2)').classList.remove('active');
    }

    const sections = document.querySelectorAll('main section.custom-section');
    const dashboard = document.getElementById('dashboard-section');
    const links = document.querySelectorAll('aside .sidebar a[data-target]');

    const params = new URLSearchParams(window.location.search);
    const urlSection = params.get('section');
    let activeSection = urlSection || localStorage.getItem('activeSection') || 'dashboard-section';

    const target = document.getElementById(activeSection);
    if(target){
        sections.forEach(s => s.classList.remove('active'));
        target.classList.add('active');
        dashboard.style.display = activeSection === 'dashboard-section' ? 'block' : 'none';
    }

    links.forEach(l=>l.classList.remove('active'));
    const activeLink = Array.from(links).find(l=>l.dataset.target === activeSection);
    if(activeLink) activeLink.classList.add('active');

    const sectionSelect = document.querySelector('select#section-select');
    if(sectionSelect) sectionSelect.value = activeSection;

    links.forEach(link=>{
        link.addEventListener('click', e=>{
            e.preventDefault();
            const target = document.getElementById(link.dataset.target);
            if(target){
                sections.forEach(s=>s.classList.remove('active'));
                if(link.dataset.target !== 'dashboard-section'){ 
                    target.classList.add('active'); 
                    dashboard.style.display = 'none'; 
                } else {
                    dashboard.style.display = 'block';
                }

                links.forEach(l=>l.classList.remove('active'));
                link.classList.add('active');
                target.scrollIntoView({behavior:'smooth'});

                localStorage.setItem('activeSection', link.dataset.target);
                const url = new URL(window.location);
                url.searchParams.set('section', link.dataset.target);
                window.history.replaceState({}, '', url);

                if(sectionSelect) sectionSelect.value = link.dataset.target;
            }
        });
    });
});


</script>
</body>
</html>
